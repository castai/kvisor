# OBI reliability metrics values for dev-master.
# Usage:
#   helm upgrade castai-kvisor charts/kvisor -n castai-agent \
#     --kube-context dev-master --reuse-values --history-max 0 \
#     -f charts/kvisor/obi-values-dev-master.yaml
#
# Key differences from obi-values.yaml (test cluster):
#   - No podMonitorLabels needed: dev-master Prometheus has podMonitorSelector: {}
#     (selects ALL PodMonitors from all namespaces).
#   - Mirrored images: dev-master has Binary Authorization (always_deny default),
#     so Docker Hub images (otel/*) are blocked. Images mirrored to castai-hub AR.
#   - Higher OBI memory limits: 38 nodes means more instrumented processes.

agent:
  reliabilityMetrics:
    enabled: true
    image:
      # Mirrored from otel/ebpf-instrument:v0.4.1 (Docker Hub blocked by BinAuthz).
      repository: us-docker.pkg.dev/castai-hub/library/otel-ebpf-instrument
      tag: "v0.4.1"
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 1Gi
    # Ports to instrument — each discovered process adds ~27 MiB to OBI memory.
    # Include common service ports on dev-master.
    openPorts: "80,443,8080,8443,8090,6379"
    env:
      # Increase internal Go channel buffer from default 10 to 500.
      # Fixes "subscriber channel is taking too long to respond" warnings
      # that cause span drops and metric under-counting on busy nodes.
      OTEL_EBPF_CHANNEL_BUFFER_LEN: "500"
      # Reduce metrics export interval from default 60s to 15s.
      # Flushes histogram aggregations 4x more often, reducing backpressure
      # on the spanNameAggregatedMetrics pipeline stage.
      OTEL_EBPF_METRICS_INTERVAL: "15s"
      # Send eBPF events immediately instead of batching — reduces burst
      # size hitting the Go pipeline during high-throughput periods.
      OTEL_EBPF_BPF_HIGH_REQUEST_VOLUME: "true"
    containerSecurityContext: {}
    collector:
      enabled: true
      clickhouseExporter:
        enabled: true
        address: "cost-report-clickhouse-zonal.clickhouse.svc.cluster.local:9000"
      image:
        # Mirrored from otel/opentelemetry-collector-contrib:0.145.0 (Docker Hub blocked by BinAuthz).
        repository: us-docker.pkg.dev/castai-hub/library/otel-collector-contrib
        tag: "0.145.0"
      resources:
        requests:
          memory: 128Mi
        limits:
          memory: 256Mi
      prometheusPort: 9400
      # No podMonitorLabels needed — dev-master Prometheus uses podMonitorSelector: {}
      # which scrapes ALL PodMonitors across all namespaces without label filtering.

controller:
  reliabilityMetrics:
    enabled: true
    collector:
      enabled: true
      clickhouseExporter:
        enabled: true
        address: "cost-report-clickhouse-zonal.clickhouse.svc.cluster.local:9000"
      image:
        # Mirrored from otel/opentelemetry-collector-contrib:0.145.0 (Docker Hub blocked by BinAuthz).
        repository: us-docker.pkg.dev/castai-hub/library/otel-collector-contrib
        tag: "0.145.0"
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 256Mi
      prometheusPort: 9401
      # No podMonitorLabels needed — dev-master Prometheus uses podMonitorSelector: {}
