# Default values for egressd.
# Declare variables to be passed into your templates.

# CAST AI API configuration.
castai:
  enabled: true

  # Token to be used for authorizing agent access to the CASTAI API
  apiKey: ""

  # Name of secret with Token to be used for authorizing agent access to the API
  # apiKey and apiKeySecretRef are mutually exclusive
  # The referenced secret must provide the token in .data["API_KEY"]
  apiKeySecretRef: ""

  # CASTAI grpc public api address.
  # Note: If your cluster is in the EU region, update the grpcAddr to: https://kvisor.prod-eu.cast.ai:443
  grpcAddr: "kvisor.prod-master.cast.ai:443"

  apiURL: ""

  # clusterID and clusterIdSecretKeyRef are mutually exclusive
  clusterID: ""
  # clusterIdSecretKeyRef -- Name and Key of secret with ClusterID
  # The referenced secret must provide the ClusterID in .data[<<.Values.castai.clusterIdSecretKeyRef.key>>]
  clusterIdSecretKeyRef:
    name: ""
    key: "CLUSTER_ID"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# Labels to add to all resources.
# TODO: Add for all resources
commonLabels: {}

# Annotations to add to all resources.
# TODO: Add for all resources
commonAnnotations: {}

image:
  repository: ghcr.io/castai/kvisor/kvisor
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

pyroscope:
  enabled: false

agent:
  enabled: false

  # -- Used to set additional volumes.
  extraVolumes: []

  # -- Used to set additional volume mounts.
  extraVolumeMounts: []

  serviceAccount:
    # Specifies whether a service account should be created
    create: true
    # Annotations to add to the service account
    annotations: {}
    # The name of the service account to use.
    # If not set and create is true, a name is generated using the fullname template
    name: ""

  # Specifies whether the service account token should be automounted.
  automountServiceAccountToken: false

  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 10

  # Allow to set priority class like system-node-critical.
  priorityClass: "system-node-critical"

  podAnnotations: {}

  podLabels: {}

  securityContext: {}

  containerSecurityContext:
    privileged: false
    runAsNonRoot: false
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
      # If empty, capabilities are added dynamically based on enabled features (see _helpers.tpl)
      # Set explicitly to override the dynamic behavior
      add: []
    seccompProfile:
      type: Unconfined
    appArmorProfile:
      type: Unconfined
    seLinuxOptions:
      level: s0
      type: spc_t
    readOnlyRootFilesystem: true

  resources:
    requests:
      memory: 64Mi
    limits:
      memory: 512Mi

  nodeSelector: {}

  tolerations:
    - effect: NoSchedule
      operator: Exists
    - effect: NoExecute
      operator: Exists

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: eks.amazonaws.com/compute-type
                operator: NotIn
                values:
                  - fargate

  dnsPolicy: ClusterFirstWithHostNet

  metricsHTTPListenPort: 6060

  # Extra args for egressd collector container.
  extraArgs:
    log-level: info
    #pyroscope-addr: http://kvisord-pyroscope:4040

  prometheusScrape:
    enabled: true

  debug:
    ebpf: false

  # Additional environment variables for the agent container.
  additionalEnv: {}

  # Additional environment variables for the agent container via configMaps or secrets.
  envFrom: []

  # Path to the container runtime socket (containerd or CRI-O)
  containerdSocketPath: "/run/containerd/containerd.sock"

  # Disable containerd-specific features (process tree, image digest resolution).
  # Set to true for CRI-O clusters.
  disableContainerd: false

  openshift:
    scc:
      create: false

  # Reliability metrics collection via OBI (OpenTelemetry eBPF Instrumentation).
  # Deploys OBI as a sidecar container in the kvisor agent DaemonSet to collect
  # RED metrics (request rate, error rate, duration histograms) from customer workloads.
  # Memory usage scales with instrumented processes (~27 MiB per process).
  reliabilityMetrics:
    enabled: false

    # --- OBI (eBPF instrumentation) settings ---
    image:
      repository: otel/ebpf-instrument
      tag: "v0.4.1"
    resources:
      requests:
        memory: 128Mi
      limits:
        memory: 512Mi
    # Ports to instrument — controls memory usage (~27 MiB per instrumented process).
    # Comma-separated list. 8080=HTTP APIs, 8090=gRPC APIs, 6379=Redis.
    openPorts: "80,443,8080,8443,8090,3000,9090,6379"
    # Extra environment variables for the OBI container.
    env: {}
    # Container security context override (if empty, uses unprivileged defaults with fine-grained capabilities).
    containerSecurityContext: {}

    # --- OTel Collector sidecar settings ---
    # Receives OTLP from OBI, applies golden signal filtering, cardinality control,
    # and batching, then exports via Prometheus scrape endpoint.
    collector:
      enabled: true
      image:
        repository: otel/opentelemetry-collector-contrib
        tag: "0.145.0"
      resources:
        requests:
          memory: 64Mi
        limits:
          memory: 128Mi
      # Port for the collector's Prometheus exporter (scraped by cluster Prometheus).
      prometheusPort: 9400

controller:
  enabled: true

  # -- Used to set additional volumes.
  extraVolumes: []

  # -- Used to set additional volume mounts.
  extraVolumeMounts: []

  replicas: 1

  serviceAccount:
    # Specifies whether a service account should be created
    create: true
    # Annotations to add to the service account
    annotations: {}
    # The name of the service account to use.
    # If not set and create is true, a name is generated using the fullname template
    name: ""

  podAnnotations: {}

  podLabels: {}

  # Allow to set priority class like system-cluster-critical.
  priorityClass: "system-cluster-critical"

  # TODO(Kvisord): Add default strict security context for all components.
  securityContext:
    fsGroup: 1001
    runAsNonRoot: true
  #    fsGroup: 10001
  #    runAsGroup: 10001
  #    runAsUser: 10001
  #    seccompProfile:
  #      type: RuntimeDefault

  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
  #    capabilities:
  #      drop: [ ALL ]

  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      memory: 512Mi

  nodeSelector: {}

  tolerations: []

  affinity: {}

  dnsPolicy: ClusterFirst

  httpListenPort: 8080
  kubeAPIListenPort: 8090
  metricsHTTPListenPort: 6060

  # Extra args for server container.
  extraArgs:
    log-level: info
    #pyroscope-addr: http://kvisord-pyroscope.kvisord-trace:4040

  prometheusScrape:
    enabled: true

  # Additional environment variables for the controller container.
  additionalEnv: {}

  # Additional environment variables for the controller container via configMaps or secrets.
  envFrom: []

  # Deprecated: use additionalEnv instead.
  extraEnv: {}

  # --- K8s cluster state metrics (reliability) ---
  # Runs an OTel Collector sidecar with k8s_cluster receiver to collect
  # KSM-equivalent infrastructure metrics (pod restarts, deployment availability,
  # node conditions, resource requests/limits). No OBI needed — purely API server watch-based.
  reliabilityMetrics:
    enabled: false
    collector:
      enabled: true
      image:
        repository: otel/opentelemetry-collector-contrib
        tag: "0.145.0"
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 256Mi
      # Port for the collector's Prometheus exporter (different from agent collector's 9400).
      prometheusPort: 9401
      # Labels to add to the PodMonitor (e.g., for Prometheus Operator selector filtering).
      podMonitorLabels: {}

eventGenerator:
  enabled: false
  image:
    repository: ghcr.io/castai/kvisor/kvisor-event-generator
    pullPolicy: IfNotPresent
    # Overrides the image tag whose default is the chart appVersion.
    tag: ""

  dnsPolicy: ClusterFirst

  extraArgs:
    log-level: debug

  tolerations:
    - effect: NoSchedule
      operator: Exists
    - effect: NoExecute
      operator: Exists

mockServer:
  enabled: false

clickhouse:
  enabled: false

  auth:
    database: "kvisor"
    username: "kvisor"
    password: "kvisor"

  image:
    repository: clickhouse/clickhouse-server
    pullPolicy: IfNotPresent
    tag: "25.2.1.3085-alpine@sha256:49e2bbe28760d0af142096d837ca2337b0265c910a07504a3175fc9326965bd7"

  nodeSelector: {}
  tolerations: []
  affinity: {}
  dnsPolicy: ClusterFirst
  persistentVolume:
    size: 20Gi
    #storageClass: premium-rwo
