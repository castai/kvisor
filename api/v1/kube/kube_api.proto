syntax = "proto3";

package kube.v1;

option go_package = "github.com/castai/kvisor/api/kube/v1";

service KubeAPI {
  rpc GetClusterInfo(GetClusterInfoRequest) returns (GetClusterInfoResponse);
  // GetIPInfo is deprecated, use GetIPsInfo.
  rpc GetIPInfo(GetIPInfoRequest) returns (GetIPInfoResponse);
  rpc GetIPsInfo(GetIPsInfoRequest) returns (GetIPsInfoResponse);
  rpc GetPod(GetPodRequest) returns (GetPodResponse);
  rpc GetNode(GetNodeRequest) returns (GetNodeResponse);
  rpc GetNodeStatsSummary(GetNodeStatsSummaryRequest) returns (GetNodeStatsSummaryResponse);
  rpc GetPodVolumes(GetPodVolumesRequest) returns (GetPodVolumesResponse);
  rpc GetCloudVolumes(GetCloudVolumesRequest) returns (GetCloudVolumesResponse);
}

message GetClusterInfoRequest {}
message GetClusterInfoResponse {
  repeated string pods_cidr = 1;
  repeated string service_cidr = 2;
  repeated string node_cidr = 4;
  repeated string vpc_cidr = 5;
  // other_cidr is a list of known cloud services CIDRs
  repeated string other_cidr = 3;
}

message GetIPInfoRequest {
  bytes ip = 1;
}

message GetIPInfoResponse {
  IPInfo info = 1;
}

message GetIPsInfoRequest {
  repeated bytes ips = 1;
}

message GetIPsInfoResponse {
  repeated IPInfo list = 1;
}

message IPInfo {
  string pod_uid = 1;
  string pod_name = 3;
  string namespace = 2;
  string workload_name = 4;
  string workload_kind = 5;
  string workload_uid = 6;
  string zone = 7;
  string region = 10;
  string node_name = 8;
  string cloud_domain = 11;
  bytes ip = 9;
}

message GetPodRequest {
  string uid = 2;
}

message GetPodResponse {
  Pod pod = 1;
}

enum WorkloadKind {
  WORKLOAD_KIND_UNKNOWN = 0;
  WORKLOAD_KIND_DEPLOYMENT = 1;
  WORKLOAD_KIND_REPLICA_SET = 2;
  WORKLOAD_KIND_STATEFUL_SET = 3;
  WORKLOAD_KIND_DAEMON_SET = 4;
  WORKLOAD_KIND_JOB = 5;
  WORKLOAD_KIND_CRONJOB = 6;
  WORKLOAD_KIND_POD = 7;
}

message Pod {
  string workload_uid = 1;
  string workload_name = 2;
  WorkloadKind workload_kind = 3;
  string zone = 4;
  string region = 6;
  string node_name = 5;
}

message GetNodeRequest {
  string name = 1;
}

message GetNodeResponse {
  Node node = 1;
}

message Node {
  string name = 1;
  map<string, string> labels = 2;
}

message GetNodeStatsSummaryRequest {
  string node_name = 1;
}

message GetNodeStatsSummaryResponse {
  NodeStats node = 1;
}

message NodeStats {
  string node_name = 1;
  int64 start_time_seconds = 2;
  CPUStats cpu = 3;
  MemoryStats memory = 4;
  NetworkStats network = 5;
  FsStats fs = 6;
  RuntimeStats runtime = 7;
}

message CPUStats {
  int64 time_seconds = 1;
  uint64 usage_nanocores = 2;
  uint64 usage_core_nanoseconds = 3;
}

message MemoryStats {
  int64 time_seconds = 1;
  uint64 available_bytes = 2;
  uint64 usage_bytes = 3;
  uint64 working_set_bytes = 4;
  uint64 rss_bytes = 5;
  uint64 page_faults = 6;
  uint64 major_page_faults = 7;
}

message NetworkStats {
  int64 time_seconds = 1;
  uint64 rx_bytes = 2;
  uint64 rx_errors = 3;
  uint64 tx_bytes = 4;
  uint64 tx_errors = 5;
}

message FsStats {
  int64 time_seconds = 1;
  uint64 available_bytes = 2;
  uint64 capacity_bytes = 3;
  uint64 used_bytes = 4;
  uint64 inodes_free = 5;
  uint64 inodes = 6;
  uint64 inodes_used = 7;
}

message RuntimeStats {
  int64 time_seconds = 1;
  FsStats image_fs = 2;
  FsStats container_fs = 3;
}

message GetPodVolumesRequest {
  string node_name = 1;
}

message GetPodVolumesResponse {
  repeated PodVolumeInfo volumes = 1;
}

message PodVolumeInfo {
  string namespace = 1;
  string pod_name = 2;
  string pod_uid = 3;
  string controller_kind = 4;
  string controller_name = 5;
  string container_name = 6;
  string volume_name = 7;
  string mount_path = 8;
  string pvc_name = 9;
  string pvc_uid = 10;
  int64 requested_size_bytes = 11;
  string pv_name = 12;
  string storage_class = 13;
  string csi_driver = 14;
  string csi_volume_handle = 15;
  string volume_mode = 16;    // "Filesystem" or "Block"
  string device_path = 17;    // For block volumes: container's volumeDevices[].devicePath
}

message GetCloudVolumesRequest {
  string node_name = 1;
}

message GetCloudVolumesResponse {
  repeated CloudVolumeInfo volumes = 1;
}

message CloudVolumeInfo {
  string cloud_provider = 1;
  string region = 2;
  string availability_zone = 3;
  string volume_id = 4;
  string volume_type = 5;
  string volume_state = 6;
  uint64 size_bytes = 7;
  uint32 iops = 8;
  uint32 throughput_bytes = 9;
  bool encrypted = 10;
}
